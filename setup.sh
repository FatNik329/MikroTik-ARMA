#!/bin/bash
# === –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è MikroTik-ARMA ===

set -e

# PART1 - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Python)

venv_name="env"

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ -d "$venv_name" ]; then
    echo "‚ö†Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$venv_name' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    read -p "–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å? (y/N) " rebuild
    if [[ "$rebuild" =~ ^[Yy]$ ]]; then
        rm -rf "$venv_name"
    else
        echo "–û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏..."
        "$venv_name/bin/pip" install -U -r requirements.txt
    fi
fi

# –°–æ–∑–¥–∞—ë—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
if [ ! -d "$venv_name" ]; then
    echo "üõ† –°–æ–∑–¥–∞—ë—Ç—Å—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$venv_name'..."
    python3 -m venv "$venv_name"

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt..."
    "$venv_name/bin/pip" install -U pip setuptools wheel  # –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    "$venv_name/bin/pip" install -r requirements.txt
fi


# PART2 - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞"
mkdir -p security cache cache/bgp_announce_routes raw-data output-data configs/AddressLists logs/base logs/additional logs/helper
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# –∏ —Ñ–∞–π–ª–æ–≤ c —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (mikrotik.yaml, notify.yaml)
## –°–æ–∑–¥–∞–Ω–∏–µ security/mikrotik.yaml
echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ security/mikrotik.yaml - —Å —à–∞–±–ª–æ–Ω–Ω—ã–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º"
cat > security/mikrotik.yaml <<EOF
# –î–∞–Ω–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–æ–º —Ä–∞–±–æ—á–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
devices:
  master1: # –†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è Master —É—Å—Ç—Ä–æ–π—Å—Ç–≤. 1-–π master
    name: "DescriptionMaster1"     # –£–¥–æ–±–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è - –æ–ø–∏—Å–∞–Ω–∏–µ
    host: 192.168.0.1              # IP –∞–¥—Ä–µ—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    username: "<Your_username_Master1>"               # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    password: "<Password_username_Master1>"    # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    type_auth:            # –†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π, —á–µ–º configs/config.yaml
      use_ssl: true       # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
    type_mode: "ips-asn"  # –†–µ–∂–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π, —á–µ–º configs/config.yaml
    settings:             # –†–∞–∑–¥–µ–ª –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –¥–æ–ø. –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è Master —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ.
      batch_size: 1500    # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ batch_size (—Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤)
      update_delay: 0.1   # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–æ–±–∞–≤–ª—è–µ–º—ã–º–∏ –∞–¥—Ä–µ—Å–∞–º–∏
      list_name: ["ExampleList", "BlockingService"] # –ü–∞—Ä–∞–º–µ—Ç—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è AddressList –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π, —á–µ–º configs/address_lists.yaml
    slaves:                             # –†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ Slave —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      - name: "DescriptionSlave1"       # –£–¥–æ–±–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è - –æ–ø–∏—Å–∞–Ω–∏–µ. 1-–π slave
        host: 192.168.1.1               # IP –∞–¥—Ä–µ—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        username: "<Your_username_Slave1>"          # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        password: "<Password_username_Slave1>"     # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        type_auth:            # –†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π, —á–µ–º configs/config.yaml
          use_ssl: true       # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É.
        settings:             # –†–∞–∑–¥–µ–ª –¥–æ–ø. –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è Slave —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          batch_size: 1500    # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ batch_size (—Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤)
          update_delay: 0.1   # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–æ–±–∞–≤–ª—è–µ–º—ã–º–∏ –∞–¥—Ä–µ—Å–∞–º–∏
        list_sync: ["TestLists", "ExampleList"]      # –°–ø–∏—Å–æ–∫ Address Lists –¥–ª—è —Å–∏–Ωx—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Master —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
      - name: "DescriptionSlave2"      # 2-–π slave
        host: 10.10.10.100
        username: "<Your_username_Slave2>"
        password: "<Password_username_Slave2>"
        settings:
          batch_size: 1500
          update_delay: 0.1
        list_sync: ["TestLists"]
EOF

## –°–æ–∑–¥–∞–Ω–∏–µ security/notify.yaml
echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ security/notify.yaml - —Å —à–∞–±–ª–æ–Ω–Ω—ã–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º"
cat > security/notify.yaml <<EOF
# ==========================
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Telegram –∏ Email
# ==========================

# –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
telegram:   # —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram
  bot_token: "API:token"
  chat_id: "<chat_id>"
email:      # —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ Email
  smtp_server: "smtp.yandex.ru"
  smtp_port: 465
  login: "example@yandex.ru"
  password: "exampleAPP-PASS"  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  from_addr: "example@yandex.ru"
  to_addr: "example@yandex.ru"

EOF

# PART3 - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç run.sh - –¥–ª—è –æ–±—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã
echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ run.sh"
cat > run.sh <<EOF
#!/bin/bash

# –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
real=\$(realpath "\$(dirname "\$0")")
cd \$real

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
"$venv_name/bin/pip" install -q -r requirements.txt

# –ó–∞–ø—É—Å–∫ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ARMA
"$venv_name/bin/python" scripts/main_start.py
EOF

chmod +x run.sh  # –ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–∞–≤–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç—É

echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ"

echo "–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–≤–µ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥—É –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: source $venv_name/bin/activate"
